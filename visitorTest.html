<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visitor Logger</title>
    <script>
        async function get_ip() {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                if (!response.ok) {
                    throw new Error('Failed to fetch IP address');
                }
                const data = await response.json();
                return data.ip || "Unknown";
            } catch (error) {
                console.error('Error fetching IP:', error);
                return "Unknown";
            }
        }

        async function get_ip_info(ip) {
            try {
                const response = await fetch(`https://ipinfo.io/${ip}/json`);
                if (!response.ok) {
                    throw new Error('Failed to fetch IP information');
                }
                const data = await response.json();
                return data;
            } catch (error) {
                console.error('Error fetching IP info:', error);
                return null;
            }
        }

        async function logVisit(ip, page) {
            const now = new Date();
            const romeTimestamp = new Intl.DateTimeFormat('it-IT', {
                timeZone: 'Europe/Rome',
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            }).format(now);

            const visitorIP = ip || await get_ip();
            const ipInfo = await get_ip_info(visitorIP);

            // Log the raw IP info for debugging
            console.log('IP Info:', ipInfo);

            const visit = {
                timestamp: romeTimestamp,
                ip: visitorIP,
                page: page || "Unknown",
                city: ipInfo?.city || "No city info",
                region: ipInfo?.region || "No region info",
                country: ipInfo?.country || "No country info",
                isp: ipInfo?.org || "No ISP info",
                latitude: ipInfo?.loc ? ipInfo.loc.split(',')[0] : "No latitude info",
                longitude: ipInfo?.loc ? ipInfo.loc.split(',')[1] : "No longitude info"
            };

            // Store the visit in localStorage (optional)
            let visits = JSON.parse(localStorage.getItem('visitorLog')) || [];
            visits.push(visit);
            localStorage.setItem('visitorLog', JSON.stringify(visits));

            console.log('Logged visit:', visit);
        }

        document.addEventListener('DOMContentLoaded', async function() {
            const currentPage = window.location.pathname || "/";
            await logVisit(null, `https://patrick2734.github.io${currentPage}`);
        });
    </script>
</head>
<body>
    <h1>Visitor Logger</h1>
    <p>This page logs visitor information.</p>
</body>
</html>
